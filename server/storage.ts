import {
  type Patient,
  type InsertPatient,
  type Appointment,
  type InsertAppointment,
  type MedicalRecord,
  type InsertMedicalRecord,
  type PendingItem,
  type InsertPendingItem,
  type RecentUpdate,
  type InsertRecentUpdate
} from "@shared/schema";
import { randomUUID } from "crypto";

export interface IStorage {
  // Patients
  getPatients(): Promise<Patient[]>;
  getPatient(id: string): Promise<Patient | undefined>;
  createPatient(patient: InsertPatient): Promise<Patient>;
  updatePatient(id: string, patient: Partial<InsertPatient>): Promise<Patient | undefined>;
  deletePatient(id: string): Promise<boolean>;

  // Appointments
  getAppointments(): Promise<Appointment[]>;
  getAppointmentsByPatient(patientId: string): Promise<Appointment[]>;
  createAppointment(appointment: InsertAppointment): Promise<Appointment>;
  updateAppointment(id: string, appointment: Partial<InsertAppointment>): Promise<Appointment | undefined>;
  deleteAppointment(id: string): Promise<boolean>;

  // Medical Records
  getMedicalRecords(): Promise<MedicalRecord[]>;
  getMedicalRecordsByPatient(patientId: string): Promise<MedicalRecord[]>;
  createMedicalRecord(record: InsertMedicalRecord): Promise<MedicalRecord>;
  updateMedicalRecord(id: string, record: Partial<InsertMedicalRecord>): Promise<MedicalRecord | undefined>;
  deleteMedicalRecord(id: string): Promise<boolean>;

  // Pending Items
  getPendingItems(): Promise<PendingItem[]>;
  getPendingItemsByPatient(patientId: string): Promise<PendingItem[]>;
  createPendingItem(item: InsertPendingItem): Promise<PendingItem>;
  updatePendingItem(id: string, item: Partial<InsertPendingItem>): Promise<PendingItem | undefined>;
  deletePendingItem(id: string): Promise<boolean>;

  // Recent Updates
  getRecentUpdates(): Promise<RecentUpdate[]>;
  createRecentUpdate(update: InsertRecentUpdate): Promise<RecentUpdate>;
}

export class MemStorage implements IStorage {
  private patients: Map<string, Patient> = new Map();
  private appointments: Map<string, Appointment> = new Map();
  private medicalRecords: Map<string, MedicalRecord> = new Map();
  private pendingItems: Map<string, PendingItem> = new Map();
  private recentUpdates: Map<string, RecentUpdate> = new Map();

  constructor() {
    this.initializeData();
  }

  private async initializeData() {
    // Initialize with sample family data
    const familyMembers = [
      {
        name: "Jo√£o Silva",
        birthDate: "1979-01-15",
        bloodType: "O+",
        doctor: "Dr. Santos",
        allergies: ["Penicilina", "Amendoim"],
        photoUrl: "üë®",
        emergencyContactName: "Maria Silva",
        emergencyContactPhone: "(11) 99999-8888",
        insurancePlan: "Unimed",
        insuranceNumber: "123456789"
      },
      {
        name: "Maria Silva",
        birthDate: "1982-03-22",
        bloodType: "A+",
        doctor: "Dra. Costa",
        allergies: ["Aspirina"],
        photoUrl: "üë©",
        emergencyContactName: "Jo√£o Silva",
        emergencyContactPhone: "(11) 99999-7777",
        insurancePlan: "Unimed",
        insuranceNumber: "987654321"
      },
      {
        name: "Ana Silva",
        birthDate: "2008-07-10",
        bloodType: "B+",
        doctor: "Dr. Oliveira",
        allergies: [],
        photoUrl: "üëß",
        emergencyContactName: "Jo√£o Silva",
        emergencyContactPhone: "(11) 99999-7777",
        insurancePlan: "Unimed",
        insuranceNumber: "456789123"
      },
      {
        name: "Pedro Silva",
        birthDate: "2012-11-05",
        bloodType: "O+",
        doctor: "Dr. Lima",
        allergies: ["P√≥len"],
        photoUrl: "üë¶",
        emergencyContactName: "Maria Silva",
        emergencyContactPhone: "(11) 99999-8888",
        insurancePlan: "Unimed",
        insuranceNumber: "789123456"
      }
    ];

    familyMembers.forEach(member => {
      const patient: Patient = {
        id: randomUUID(),
        ...member,
        sensitiveDataPasswordActive: false,
        sensitiveDataPassword: null,
        insuranceCardFrontUrl: null,
        insuranceCardBackUrl: null,
        idCardFrontUrl: null,
        idCardBackUrl: null,
        createdAt: new Date()
      };
      this.patients.set(patient.id, patient);
    });

    // Add sample medical records for testing
    const sampleMedicalRecords = [
      // Jo√£o Silva - Exames
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'exam',
        title: 'Exame de Sangue Completo',
        description: 'Hemograma completo com contagem de plaquetas',
        date: '2024-01-15',
        examType: 'Laboratorial',
        requestingDoctor: 'Dr. Santos',
        observations: 'Valores dentro da normalidade'
      },
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'exam',
        title: 'Raio-X de T√≥rax',
        description: 'Radiografia do t√≥rax para avalia√ß√£o pulmonar',
        date: '2024-01-20',
        examType: 'Imagem',
        requestingDoctor: 'Dr. Santos',
        observations: 'Sem altera√ß√µes significativas'
      },
      // Jo√£o Silva - Medica√ß√µes
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'medication',
        title: 'Losartana 50mg',
        description: 'Para controle da press√£o arterial',
        date: '2024-01-10',
        medicationName: 'Losartana',
        frequency: '1x ao dia',
        usageType: 'continuous',
        periodOfDay: 'morning',
        prescribingDoctor: 'Dr. Santos',
        indication: 'Hipertens√£o arterial'
      },
      // Jo√£o Silva - Consultas
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'appointment',
        title: 'Consulta Cardiol√≥gica',
        description: 'Avalia√ß√£o cardiovascular de rotina',
        date: '2024-02-15',
        time: '14:30',
        doctor: 'Dr. Cardoso',
        specialty: 'Cardiologia',
        clinicHospital: 'Hospital S√£o Lucas',
        address: 'Rua das Flores, 123'
      },
      // Jo√£o Silva - Hist√≥rico
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'history',
        title: 'Cirurgia de Apendicite',
        description: 'Apendicectomia realizada em 2020 sem complica√ß√µes',
        date: '2020-08-15'
      },
      // Jo√£o Silva - Incidente
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'incident',
        title: 'Queda em Casa',
        description: 'Paciente sofreu queda no banheiro, sem fraturas',
        date: '2024-01-25'
      },
      // Jo√£o Silva - Credencial
      {
        patientId: Array.from(this.patients.values())[0].id,
        type: 'credential',
        title: 'Portal do Paciente - Hospital S√£o Lucas',
        description: 'Acesso ao portal online do hospital',
        date: '2024-01-05',
        serviceName: 'Portal S√£o Lucas',
        serviceUrl: 'https://portal.saolucas.com.br',
        username: 'joao.silva',
        password: 'senha123',
        additionalNotes: 'Primeiro acesso requer troca de senha'
      },

      // Maria Silva - Exames
      {
        patientId: Array.from(this.patients.values())[1].id,
        type: 'exam',
        title: 'Mamografia',
        description: 'Exame preventivo de mama',
        date: '2024-01-12',
        examType: 'Imagem',
        requestingDoctor: 'Dra. Costa',
        observations: 'Resultado normal, pr√≥ximo exame em 1 ano'
      },
      {
        patientId: Array.from(this.patients.values())[1].id,
        type: 'exam',
        title: 'Papanicolau',
        description: 'Exame preventivo ginecol√≥gico',
        date: '2024-01-18',
        examType: 'Laboratorial',
        requestingDoctor: 'Dra. Costa',
        observations: 'C√©lulas normais'
      },
      // Maria Silva - Medica√ß√µes
      {
        patientId: Array.from(this.patients.values())[1].id,
        type: 'medication',
        title: 'Vitamina D3',
        description: 'Suplementa√ß√£o vitam√≠nica',
        date: '2024-01-08',
        medicationName: 'Colecalciferol',
        frequency: '1x por semana',
        usageType: 'temporary',
        periodOfDay: 'morning',
        duration: '3 meses',
        prescribingDoctor: 'Dra. Costa',
        indication: 'Defici√™ncia de vitamina D'
      },
      // Maria Silva - Consultas
      {
        patientId: Array.from(this.patients.values())[1].id,
        type: 'appointment',
        title: 'Consulta Ginecol√≥gica',
        description: 'Consulta de rotina e preventivo',
        date: '2024-02-20',
        time: '10:00',
        doctor: 'Dra. Costa',
        specialty: 'Ginecologia',
        clinicHospital: 'Cl√≠nica Feminina',
        address: 'Av. Paulista, 456'
      },
      // Maria Silva - Hist√≥rico
      {
        patientId: Array.from(this.patients.values())[1].id,
        type: 'history',
        title: 'Parto Normal - Ana',
        description: 'Parto normal da filha Ana em 2008, sem complica√ß√µes',
        date: '2008-07-10'
      },
      // Maria Silva - Credencial
      {
        patientId: Array.from(this.patients.values())[1].id,
        type: 'credential',
        title: 'App Unimed',
        description: 'Aplicativo do plano de sa√∫de',
        date: '2024-01-03',
        serviceName: 'Unimed App',
        serviceUrl: 'https://app.unimed.com.br',
        username: 'maria.silva82',
        password: 'unimed2024',
        additionalNotes: 'Renovar senha a cada 6 meses'
      },

      // Ana Silva - Exames
      {
        patientId: Array.from(this.patients.values())[2].id,
        type: 'exam',
        title: 'Exame Oftalmol√≥gico',
        description: 'Avalia√ß√£o da vis√£o e sa√∫de ocular',
        date: '2024-01-22',
        examType: 'Cl√≠nico',
        requestingDoctor: 'Dr. Oliveira',
        observations: 'Vis√£o normal para a idade'
      },
      // Ana Silva - Medica√ß√µes
      {
        patientId: Array.from(this.patients.values())[2].id,
        type: 'medication',
        title: 'Xarope para Tosse',
        description: 'Tratamento para tosse seca',
        date: '2024-01-28',
        medicationName: 'Dextrometorfano',
        frequency: '3x ao dia',
        usageType: 'temporary',
        periodOfDay: 'any',
        duration: '7 dias',
        prescribingDoctor: 'Dr. Oliveira',
        indication: 'Tosse seca persistente'
      },
      // Ana Silva - Consultas
      {
        patientId: Array.from(this.patients.values())[2].id,
        type: 'appointment',
        title: 'Consulta Pedi√°trica',
        description: 'Acompanhamento do crescimento e desenvolvimento',
        date: '2024-03-10',
        time: '15:00',
        doctor: 'Dr. Oliveira',
        specialty: 'Pediatria',
        clinicHospital: 'Cl√≠nica Infantil',
        address: 'Rua das Crian√ßas, 789'
      },
      // Ana Silva - Hist√≥rico
      {
        patientId: Array.from(this.patients.values())[2].id,
        type: 'history',
        title: 'Vacina√ß√£o HPV',
        description: 'Primeira dose da vacina contra HPV',
        date: '2023-07-10'
      },
      // Ana Silva - Incidente
      {
        patientId: Array.from(this.patients.values())[2].id,
        type: 'incident',
        title: 'Queda da Bicicleta',
        description: 'Escoria√ß√µes no joelho direito, curativo realizado',
        date: '2024-01-30'
      },

      // Pedro Silva - Exames
      {
        patientId: Array.from(this.patients.values())[3].id,
        type: 'exam',
        title: 'Teste Al√©rgico',
        description: 'Teste cut√¢neo para identifica√ß√£o de al√©rgenos',
        date: '2024-01-14',
        examType: 'Cl√≠nico',
        requestingDoctor: 'Dr. Lima',
        observations: 'Positivo para p√≥len de gram√≠neas'
      },
      // Pedro Silva - Medica√ß√µes
      {
        patientId: Array.from(this.patients.values())[3].id,
        type: 'medication',
        title: 'Antial√©rgico Infantil',
        description: 'Para controle dos sintomas al√©rgicos',
        date: '2024-01-16',
        medicationName: 'Loratadina',
        frequency: '1x ao dia',
        usageType: 'continuous',
        periodOfDay: 'evening',
        prescribingDoctor: 'Dr. Lima',
        indication: 'Rinite al√©rgica'
      },
      // Pedro Silva - Consultas
      {
        patientId: Array.from(this.patients.values())[3].id,
        type: 'appointment',
        title: 'Consulta com Alergista',
        description: 'Avalia√ß√£o e ajuste do tratamento para alergia',
        date: '2024-02-28',
        time: '16:30',
        doctor: 'Dra. Almeida',
        specialty: 'Alergologia',
        clinicHospital: 'Centro de Alergia',
        address: 'Rua da Sa√∫de, 321'
      },
      // Pedro Silva - Hist√≥rico
      {
        patientId: Array.from(this.patients.values())[3].id,
        type: 'history',
        title: 'Primeira Crise Al√©rgica',
        description: 'Primeira manifesta√ß√£o de rinite al√©rgica aos 8 anos',
        date: '2020-11-05'
      },
      // Pedro Silva - Credencial
      {
        patientId: Array.from(this.patients.values())[3].id,
        type: 'credential',
        title: 'Portal Escolar',
        description: 'Acesso ao sistema da escola para acompanhamento m√©dico',
        date: '2024-01-02',
        serviceName: 'Portal Escola ABC',
        serviceUrl: 'https://escola-abc.edu.br',
        username: 'pedro.silva',
        password: 'escola123',
        additionalNotes: 'Informa√ß√µes m√©dicas compartilhadas com enfermaria'
      }
    ];

    // Create medical records
    sampleMedicalRecords.forEach((recordData, index) => {
      let attachments: string[] = [];

      // Adicionar anexos de exemplo para alguns registros
      if (index === 0) { // Primeiro exame de Jo√£o Silva
        attachments = ['imagem.png', 'documento.pdf'];
      } else if (index === 7) { // Mamografia de Maria Silva
        attachments = ['file-1755952130246-895406567.jpg'];
      } else if (index === 13) { // Exame oftalmol√≥gico de Ana Silva
        attachments = ['file-1755952144423-604867207.jpg'];
      }

      const record: MedicalRecord = {
        id: randomUUID(),
        ...recordData,
        attachments,
        createdAt: new Date()
      };
      this.medicalRecords.set(record.id, record);
    });

    // Add sample pending items
    const samplePendingItems = [
      {
        patientId: Array.from(this.patients.values())[0].id,
        title: 'Agendar Retorno Cardiol√≥gico',
        description: 'Marcar consulta de retorno em 6 meses',
        priority: 'medium'
      },
      {
        patientId: Array.from(this.patients.values())[1].id,
        title: 'Renovar Receita Vitamina D',
        description: 'Solicitar nova receita com a Dra. Costa',
        priority: 'high'
      },
      {
        patientId: Array.from(this.patients.values())[2].id,
        title: 'Agendar Consulta Ortod√¥ntica',
        description: 'Primeira consulta para avalia√ß√£o ortod√¥ntica',
        priority: 'low'
      },
      {
        patientId: Array.from(this.patients.values())[3].id,
        title: 'Comprar Medica√ß√£o Antial√©rgica',
        description: 'Renovar estoque da Loratadina',
        priority: 'medium'
      }
    ];

    // Create pending items
    samplePendingItems.forEach(itemData => {
      const item: PendingItem = {
        id: randomUUID(),
        ...itemData,
        completed: false,
        createdAt: new Date()
      };
      this.pendingItems.set(item.id, item);
    });

    // Add sample recent updates
    const updates = [
      { patientName: "Jo√£o Silva", description: "Novo exame de sangue adicionado", icon: "üìã" },
      { patientName: "Maria Silva", description: "Medica√ß√£o atualizada", icon: "üíä" },
      { patientName: "Ana Silva", description: "Consulta agendada com Dr. Oliveira", icon: "üìÖ" }
    ];

    updates.forEach(update => {
      const patient = Array.from(this.patients.values()).find(p => p.name === update.patientName);
      if (patient) {
        const recentUpdate: RecentUpdate = {
          id: randomUUID(),
          patientId: patient.id,
          ...update,
          createdAt: new Date()
        };
        this.recentUpdates.set(recentUpdate.id, recentUpdate);
      }
    });
  }

  // Patients
  async getPatients(): Promise<Patient[]> {
    return Array.from(this.patients.values());
  }

  async getPatient(id: string): Promise<Patient | undefined> {
    return this.patients.get(id);
  }

  async createPatient(insertPatient: InsertPatient): Promise<Patient> {
    const id = randomUUID();
    const patient: Patient = {
      ...insertPatient,
      id,
      createdAt: new Date()
    };
    this.patients.set(id, patient);
    return patient;
  }

  async updatePatient(id: string, updateData: Partial<InsertPatient>): Promise<Patient | undefined> {
    const patient = this.patients.get(id);
    if (!patient) return undefined;

    const updatedPatient: Patient = { ...patient, ...updateData };
    this.patients.set(id, updatedPatient);
    return updatedPatient;
  }

  async deletePatient(id: string): Promise<boolean> {
    await this.deleteAppointmentsByPatient(id);
    await this.deleteMedicalRecordsByPatient(id);
    await this.deletePendingItemsByPatient(id);
    await this.deleteRecentUpdatesByPatient(id);
    return this.patients.delete(id);
  }

  // Appointments
  async getAppointments(): Promise<Appointment[]> {
    return Array.from(this.appointments.values());
  }

  async getAppointmentsByPatient(patientId: string): Promise<Appointment[]> {
    return Array.from(this.appointments.values()).filter(a => a.patientId === patientId);
  }

  async createAppointment(insertAppointment: InsertAppointment): Promise<Appointment> {
    const id = randomUUID();
    const appointment: Appointment = {
      ...insertAppointment,
      id,
      createdAt: new Date()
    };
    this.appointments.set(id, appointment);
    return appointment;
  }

  async updateAppointment(id: string, updateData: Partial<InsertAppointment>): Promise<Appointment | undefined> {
    const appointment = this.appointments.get(id);
    if (!appointment) return undefined;

    const updatedAppointment: Appointment = { ...appointment, ...updateData };
    this.appointments.set(id, updatedAppointment);
    return updatedAppointment;
  }

  async deleteAppointment(id: string): Promise<boolean> {
    return this.appointments.delete(id);
  }

  async deleteAppointmentsByPatient(patientId: string): Promise<void> {
    const appointmentsToDelete = Array.from(this.appointments.values())
      .filter(appointment => appointment.patientId === patientId);

    appointmentsToDelete.forEach(appointment => {
      this.appointments.delete(appointment.id);
    });
  }


  // Medical Records
  async getMedicalRecords(): Promise<MedicalRecord[]> {
    return Array.from(this.medicalRecords.values());
  }

  async getMedicalRecordsByPatient(patientId: string): Promise<MedicalRecord[]> {
    return Array.from(this.medicalRecords.values()).filter(r => r.patientId === patientId);
  }

  async createMedicalRecord(insertRecord: InsertMedicalRecord): Promise<MedicalRecord> {
    const id = randomUUID();
    const record: MedicalRecord = {
      ...insertRecord,
      id,
      createdAt: new Date()
    };
    this.medicalRecords.set(id, record);
    return record;
  }

  async updateMedicalRecord(id: string, updateData: Partial<InsertMedicalRecord>): Promise<MedicalRecord | undefined> {
    const record = this.medicalRecords.get(id);
    if (!record) return undefined;

    const updatedRecord: MedicalRecord = { ...record, ...updateData };
    this.medicalRecords.set(id, updatedRecord);
    return updatedRecord;
  }

  async deleteMedicalRecord(id: string): Promise<boolean> {
    return this.medicalRecords.delete(id);
  }

  async deleteMedicalRecordsByPatient(patientId: string): Promise<void> {
    const recordsToDelete = Array.from(this.medicalRecords.values())
      .filter(record => record.patientId === patientId);

    recordsToDelete.forEach(record => {
      this.medicalRecords.delete(record.id);
    });
  }

  // Pending Items
  async getPendingItems(): Promise<PendingItem[]> {
    return Array.from(this.pendingItems.values());
  }

  async getPendingItemsByPatient(patientId: string): Promise<PendingItem[]> {
    return Array.from(this.pendingItems.values()).filter(i => i.patientId === patientId);
  }

  async createPendingItem(insertItem: InsertPendingItem): Promise<PendingItem> {
    const id = randomUUID();
    const item: PendingItem = {
      ...insertItem,
      id,
      createdAt: new Date()
    };
    this.pendingItems.set(id, item);
    return item;
  }

  async updatePendingItem(id: string, updateData: Partial<InsertPendingItem>): Promise<PendingItem | undefined> {
    const item = this.pendingItems.get(id);
    if (!item) return undefined;

    const updatedItem: PendingItem = { ...item, ...updateData };
    this.pendingItems.set(id, updatedItem);
    return updatedItem;
  }

  async deletePendingItem(id: string): Promise<boolean> {
    return this.pendingItems.delete(id);
  }

  // Recent Updates
  async getRecentUpdates(): Promise<RecentUpdate[]> {
    return Array.from(this.recentUpdates.values())
      .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())
      .slice(0, 10);
  }

  async deletePendingItemsByPatient(patientId: string): Promise<void> {
    const itemsToDelete = Array.from(this.pendingItems.values())
      .filter(item => item.patientId === patientId);

    itemsToDelete.forEach(item => {
      this.pendingItems.delete(item.id);
    });
  }

  async deleteRecentUpdatesByPatient(patientId: string): Promise<void> {
    const updatesToDelete = Array.from(this.recentUpdates.values())
      .filter(update => update.patientId === patientId);

    updatesToDelete.forEach(update => {
      this.recentUpdates.delete(update.id);
    });
  }
}

export const storage = new MemStorage();